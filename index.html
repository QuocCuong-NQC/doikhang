<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GIáº¢I IPES Má» Rá»˜NG NÄ‚M 2025 â€” Báº£ng cháº¥m Ä‘iá»ƒm (Realtime V4.2 - Final)</title>
<style>
:root{
Â  --bg:#050405; --panel:#0f1113; --accent:#ffcc00;
Â  --red1:#c82323; --red2:#7a0d0d; --blue1:#0b66ff; --blue2:#002a8a;
Â  --muted:rgba(255,255,255,0.06);
Â  --judge-light-off:#111; --judge-light-on:#ffea3b;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, "Segoe UI", Tahoma, Arial, sans-serif;background:linear-gradient(180deg,#030303,#0b0b0b);color:#fff;}
/* TOP DISPLAY - fills viewport */
#displaySection{height:100vh;padding:18px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.display-wrap{width:98%;max-width:1500px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:20px;border-radius:14px;box-shadow:0 20px 80px rgba(0,0,0,.7);display:flex;gap:18px;align-items:stretch;position:relative;}
/* Sá»¬A Lá»–I MÃ€U Äá»: Äáº£m báº£o left luÃ´n lÃ  red-panel */
.left {flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; position:relative;}
.right {flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; position:relative;}
.center {width:520px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;}
/* UPDATED: bigger title and subtitle */
.title-top{font-size:48px; font-weight:900; color:var(--accent); text-transform:uppercase; letter-spacing:3px; text-align:center; margin-top:-18px;}
.match-event{font-size:20px; color: rgba(255,255,255,0.95); font-weight:900; margin-top:8px; text-align:center;}
.round-label{font-size:36px;color:#bdf6ff;font-weight:900;margin-top:8px;}
.clock{background:linear-gradient(90deg,#fff6c0,#fff0a0);color:#000;padding:12px 22px;border-radius:16px;font-size:48px;font-weight:900;box-shadow:0 10px 30px rgba(255,204,0,0.12);min-width:220px;text-align:center;}
.fighter-card{width:100%;border-radius:12px;padding:18px;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.red-panel{background:linear-gradient(180deg,var(--red1),var(--red2));}
.blue-panel{background:linear-gradient(180deg,var(--blue1),var(--blue2));}
.fighter-name{font-weight:900;font-size:20px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.06);text-transform:uppercase;}
.score-big{font-size:110px;font-weight:900;text-shadow:0 8px 26px rgba(0,0,0,.6);}

/* judge lights row under each fighter */
.judge-lights{display:flex;gap:12px;margin-top:12px;justify-content:center;}
.judge-light{width:84px;height:72px;border-radius:10px;background:var(--judge-light-off);display:flex;flex-direction:column;align-items:center;justify-content:center;color:#ddd;font-weight:900;transition:all .12s ease;position:relative;overflow:hidden;}
.judge-light .badge{font-size:16px;z-index:1}
.judge-light .sub{font-size:14px;opacity:.95;margin-top:4px;z-index:1}
.judge-light.on{background:var(--judge-light-on);color:#000;box-shadow:0 10px 40px rgba(255,230,60,.28);transform:translateY(-4px) scale(1.02);}

/* large +1/+2 overlay when light is on */
.judge-light .overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:28px;z-index:2;pointer-events:none;opacity:0;transition:opacity .08s linear;}
.judge-light.showPoints .overlay{opacity:1;color:#000}

/* white flash overlay for winner */
.winner-flash{ position:absolute; inset:0; background:rgba(255,255,255,0.95); mix-blend-mode:screen; pointer-events:none; opacity:0; transition:opacity .08s linear; border-radius:12px; }

Â /* CONTROL SECTION */
section.section{padding:22px 6%;max-width:1400px;margin:0 auto 36px;}
#controlSection{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:12px;box-shadow:0 12px 50px rgba(0,0,0,0.6);padding:20px;}
.controls-top{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between;}
.controls-left{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
label.small{color:var(--accent);font-weight:800;margin-right:6px;}
input[type="text"],input[type="number"]{padding:10px 12px;border-radius:8px;border:none;background:rgba(255,255,255,0.04);color:#fff;font-weight:800;}
.controls-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:12px;}
.btn{padding:12px 18px;border-radius:10px;border:none;font-weight:900;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.45);}
.btn-primary{background:var(--accent);color:#000;}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;}
.btn-danger{background:#ff6b6b;color:#000;}
.btn-blue{background:#63a0ff;color:#000;}
.btn-large{padding:16px 22px;border-radius:12px;font-size:18px;}

/* new round selection buttons */
.select-rounds{display:flex;gap:8px;align-items:center;}
.round-select-btn{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);color:#fff;cursor:pointer;font-weight:800;}
.round-select-btn.active{background:var(--accent);color:#000;border-color:var(--accent);}

/* REST timer small UI */
.small-note{color:rgba(255,255,255,0.7);font-size:13px;}

/* JUDGES SECTION (big single-card per device) */
.judges{display:flex;flex-direction:column;gap:18px;margin-top:18px;}
.judge-card{display:flex;flex-direction:column;gap:12px;padding:18px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));align-items:stretch;}
.judge-header{text-align:center;font-weight:900;font-size:34px;color:var(--accent);}
.judge-body{display:flex;gap:12px;align-items:center;justify-content:space-between;}
.judge-column{flex:1;display:flex;flex-direction:column;gap:12px;align-items:center;}
.vote-btn{padding:22px 28px;border-radius:12px;font-weight:900;min-width:160px;cursor:pointer;font-size:20px;}
.v-red{background:linear-gradient(90deg,#ff8a8a,#ff4a4a);color:#000;}
.v-blue{background:linear-gradient(90deg,#9ecbff,#4a88ff);color:#000;}

/* responsive: each judge should fit phone */
@media (max-width:900px){
Â  .display-wrap{flex-direction:column;align-items:stretch;padding:16px;}
Â  .center{order:-1;width:100%;}
Â  .score-big{font-size:84px;}
Â  .title-top{font-size:28px;}
Â  .judge-header{font-size:26px;}
Â  .vote-btn{min-width:140px;padding:18px 22px;font-size:18px;}
}
.footer-note{text-align:center;color:rgba(255,255,255,0.6);padding:18px;font-size:13px;}
/* simple blink animation for win (not used; kept) */
@keyframes strongBlink{0%{box-shadow:0 0 8px 8px rgba(255,255,255,0.25)}50%{box-shadow:0 0 40px 20px rgba(255,255,255,0.05)}100%{box-shadow:none}}
.blink-win{animation:strongBlink 0.6s ease-in-out 8;}
</style>
</head>
<body>

<section id="displaySection" aria-label="MÃ n hÃ¬nh trÃ¬nh chiáº¿u">
Â  <div class="display-wrap" id="display">
Â  Â  <div class="left fighter-card red-panel" id="leftCard">
Â  Â  Â  <div class="fighter-name" id="displayRedName">VÄV Äá»</div>
Â  Â  Â  <div class="score-big" id="displayRedScore">0</div>
Â  Â  Â  <div class="judge-lights" id="displayRedLights"></div>
Â  Â  Â  Â  Â  Â  <div class="winner-flash" id="leftFlash" style="opacity:0;"></div>
Â  Â  </div>

Â  Â  <div class="center">
Â  Â  Â  <div class="title-top" id="eventTitle">GIáº¢I IPES Má» Rá»˜NG NÄ‚M 2025</div>
Â  Â  Â  <div class="match-event" id="displayEventSub">Ná»™i dung thi Ä‘áº¥u: Äá»‘i khÃ¡ng biá»ƒu diá»…n (chá»‰nh Ä‘Æ°á»£c)</div>

Â  Â  Â  Â  Â  Â  <div class="round-label" id="displayRound">Hiá»‡p 1</div>

Â  Â  Â  <div class="clock" id="displayClock">01:30</div>
Â  Â  </div>

Â  Â  <div class="right fighter-card blue-panel" id="rightCard">
Â  Â  Â  <div class="fighter-name" id="displayBlueName">VÄV XANH</div>
Â  Â  Â  <div class="score-big" id="displayBlueScore">0</div>
Â  Â  Â  <div class="judge-lights" id="displayBlueLights"></div>
Â  Â  Â  Â  Â  Â  <div class="winner-flash" id="rightFlash" style="opacity:0;"></div>
Â  Â  </div>
Â  </div>
</section>

<section id="controlSection" class="section" aria-label="Báº£ng Ä‘iá»u khiá»ƒn">
Â  <div class="controls-top">
Â  Â  <div class="controls-left">
Â  Â  Â  <label class="small">TÃªn Giáº£i:</label>
Â  Â  Â  <input id="tournamentName" type="text" value="GIáº¢I IPES Má» Rá»˜NG NÄ‚M 2025" />
Â  Â  Â  <label class="small">VÄV Äá»:</label>
Â  Â  Â  <input id="redName" type="text" value="Quá»‘c CÆ°á»ng" />
Â  Â  Â  <label class="small">VÄV XANH:</label>
Â  Â  Â  <input id="blueName" type="text" value="HÆ°ng Thá»‹nh" />
Â  Â  </div>

Â  Â  <div style="display:flex;gap:10px;align-items:center;">
Â  Â  Â  Â  Â  Â  <label class="small">Hiá»‡p sá»‘:</label>
Â  Â  Â  <input id="inputRound" type="number" value="1" min="1" style="width:80px"/>
Â  Â  </div>
Â  </div>

Â  <div class="controls-row" style="margin-top:14px;">
Â  Â  <button class="btn btn-primary btn-large" id="btnStart">Báº¯t Ä‘áº§u</button>
Â  Â  <button class="btn btn-ghost btn-large" id="btnPause">Dá»«ng</button>
Â  Â  <button class="btn btn-ghost btn-large" id="btnResume">Tiáº¿p tá»¥c</button>
Â  Â  Â  Â  <button class="btn btn-danger btn-large" id="btnReset">Reset</button>

Â  Â  <div style="flex:1"></div>

Â  Â  <button class="btn btn-ghost btn-large" id="btnFullscreenControl">Full mÃ n hÃ¬nh</button>
Â  Â  <button class="btn btn-ghost btn-large" id="btnWinRed">Äá» tháº¯ng</button>
Â  Â  <button class="btn btn-ghost btn-large" id="btnWinBlue">Xanh tháº¯ng</button>
Â  </div>

Â  Â  <div style="margin-top:12px; display:flex; align-items:center; gap:12px;">
Â  Â  <label class="small">Chá»n:</label>
Â  Â  <div class="select-rounds" id="roundSelects">
Â  Â  Â  <button class="round-select-btn active" id="selRound1">Hiá»‡p 1</button>
Â  Â  Â  <button class="round-select-btn" id="selRound2">Hiá»‡p 2</button>
Â  Â  Â  <button class="round-select-btn" id="selRound3">Hiá»‡p 3</button>
Â  Â  Â  <button class="round-select-btn" id="selRest">Giáº£i lao</button>
Â  Â  </div>

Â  Â  <div style="flex:1"></div>
Â  Â  <div class="small-note">Ã‚m thanh bÃ¡o: ON/OFF <input type="checkbox" id="soundToggle" checked></div>
Â  </div>

Â  Â  <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
Â  Â  <label class="small">Ná»™i dung thi Ä‘áº¥u:</label>
Â  Â  <input id="eventSubInput" type="text" value="Äá»‘i khÃ¡ng biá»ƒu diá»…n" style="flex:1; padding:10px; border-radius:8px; background:rgba(255,255,255,0.04); border:none; color:#fff; font-weight:800;">
Â  Â  </div>

Â  <div style="margin-top:12px;display:flex;gap:12px;align-items:center;">
Â  Â  <button class="btn btn-ghost" onclick="manualScore('red',1)">+1 Äá» (TT)</button>
Â  Â  <button class="btn btn-ghost" onclick="manualScore('red',-1)">-1 Äá» (TT)</button>
Â  Â  <button class="btn btn-ghost" onclick="manualScore('blue',1)">+1 Xanh (TT)</button>
Â  Â  <button class="btn btn-ghost" onclick="manualScore('blue',-1)">-1 Xanh (TT)</button>

Â  Â  <div style="flex:1"></div>
Â  </div>
</section>

<section class="section" id="judgesSection" aria-label="GiÃ¡m Ä‘á»‹nh">
Â  <div class="judges">

Â  Â  <div class="judge-card" id="judge1">
Â  Â  Â  <div class="judge-header">GÄ1</div>
Â  Â  Â  <div class="judge-body">
Â  Â  Â  Â  <div class="judge-column" style="align-items:flex-end;">
Â  Â  Â  Â  Â  <div style="font-weight:900;margin-bottom:6px;color:#fff">Äá»</div>
Â  Â  Â  Â  Â  <button class="vote-btn v-red" onclick="judgeVote(1,'red',1)">+1</button>
Â  Â  Â  Â  Â  <button class="vote-btn v-red" onclick="judgeVote(1,'red',2)">+2</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="width:2px;background:rgba(255,255,255,0.03);height:100%;"></div>
Â  Â  Â  Â  <div class="judge-column" style="align-items:flex-start;">
Â  Â  Â  Â  Â  <div style="font-weight:900;margin-bottom:6px;color:#fff">XANH</div>
Â  Â  Â  Â  Â  <button class="vote-btn v-blue" onclick="judgeVote(1,'blue',1)">+1</button>
Â  Â  Â  Â  Â  <button class="vote-btn v-blue" onclick="judgeVote(1,'blue',2)">+2</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>

Â  Â  <div class="judge-card" id="judge2">
Â  Â  Â  <div class="judge-header">GÄ2</div>
Â  Â  Â  <div class="judge-body">
Â  Â  Â  Â  <div class="judge-column" style="align-items:flex-end;">
Â  Â  Â  Â  Â  <div style="font-weight:900;margin-bottom:6px;color:#fff">Äá»</div>
Â  Â  Â  Â  Â  <button class="vote-btn v-red" onclick="judgeVote(2,'red',1)">+1</button>
Â  Â  Â  Â  Â  <button class="vote-btn v-red" onclick="judgeVote(2,'red',2)">+2</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="width:2px;background:rgba(255,255,255,0.03);height:100%;"></div>
Â  Â  Â  Â  <div class="judge-column" style="align-items:flex-start;">
Â  Â  Â  Â  Â  <div style="font-weight:900;margin-bottom:6px;color:#fff">XANH</div>
Â  Â  Â  Â  Â  <button class="vote-btn v-blue" onclick="judgeVote(2,'blue',1)">+1</button>
Â  Â  Â  Â  Â  <button class="vote-btn v-blue" onclick="judgeVote(2,'blue',2)">+2</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â 
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="judge-card" id="judge3">
Â  Â  Â  <div class="judge-header">GÄ3</div>
Â  Â  Â  <div class="judge-body">
Â  Â  Â  Â  <div class="judge-column" style="align-items:flex-end;">
Â  Â  Â  Â  Â  <div style="font-weight:900;margin-bottom:6px;color:#fff">Äá»</div>
Â  Â  Â  Â  Â  <button class="vote-btn v-red" onclick="judgeVote(3,'red',1)">+1</button>
Â  Â  Â  Â  Â  <button class="vote-btn v-red" onclick="judgeVote(3,'red',2)">+2</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="width:2px;background:rgba(255,255,255,0.03);height:100%;"></div>
Â  Â  Â  Â  <div class="judge-column" style="align-items:flex-start;">
Â  Â  Â  Â  Â  <div style="font-weight:900;margin-bottom:6px;color:#fff">XANH</div>
Â  Â  Â  Â  Â  <button class="vote-btn v-blue" onclick="judgeVote(3,'blue',1)">+1</button>
Â  Â  Â  Â  Â  <button class="vote-btn v-blue" onclick="judgeVote(3,'blue',2)">+2</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  </div>
</section>

<footer class="footer-note">PhiÃªn báº£n v4.2 â€” Realtime Firebase. Upload lÃªn GitHub Pages / Netlify Ä‘á»ƒ dÃ¹ng nhiá»u thiáº¿t bá»‹.</footer>

<script>
/* CÃC GIÃ TRá»Š THá»œI GIAN Cá» Äá»ŠNH */
const DEFAULT_ROUND_TIME = 90; // 1 phÃºt 30 giÃ¢y
const DEFAULT_REST_TIME = 45; // 45 giÃ¢y

/* STATE */
let state = {
Â  redScore:0, blueScore:0, round:1,
Â  timePerRound:DEFAULT_ROUND_TIME, timeLeft:DEFAULT_ROUND_TIME, timerRunning:false, lastUpdate:Date.now(),
Â  restTime:DEFAULT_REST_TIME, restLeft:DEFAULT_REST_TIME, restRunning:false,
Â  votes:[], 
Â  processedAwardKeys:new Set(), 
Â  judgeLightTimeouts:{}
};
// Biáº¿n cá» Global Ä‘á»ƒ kiá»ƒm soÃ¡t viá»‡c xá»­ lÃ½ votes liÃªn tá»¥c
window.processingAward = false;

/* DOM */
const displayRedScore = document.getElementById('displayRedScore');
const displayBlueScore = document.getElementById('displayBlueScore');
const displayRedName = document.getElementById('displayRedName');
const displayBlueName = document.getElementById('displayBlueName');
const displayRound = document.getElementById('displayRound');
const displayClock = document.getElementById('displayClock');
const tournamentNameInput = document.getElementById('tournamentName');
const redNameInput = document.getElementById('redName');
const blueNameInput = document.getElementById('blueName');
const inputRound = document.getElementById('inputRound');
const soundToggle = document.getElementById('soundToggle');
const eventTitle = document.getElementById('eventTitle');
const eventSubDisplay = document.getElementById('displayEventSub');
const eventSubInput = document.getElementById('eventSubInput');

/* selected round mode: 'round1','round2','round3','rest' (default round1) */
let selectedMode = 'round1';

/* UTILS */
function formatTime(sec){ const m = Math.floor(sec/60).toString().padStart(2,'0'); const s = (sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }

function updateDisplay(){
Â  displayRedScore.innerText = state.redScore;
Â  displayBlueScore.innerText = state.blueScore;
Â  // Display title based on selectedMode (if rest show 'Hiá»‡p giáº£i lao', else 'Hiá»‡p N')
Â  if(selectedMode === 'rest') displayRound.innerText = 'Giáº£i lao';
Â  else {
Â  Â  const rnum = parseInt(inputRound.value) || state.round || 1;
Â  Â  // Hiá»ƒn thá»‹ sá»‘ hiá»‡p dá»±a trÃªn nÃºt Ä‘Æ°á»£c chá»n vÃ  giÃ¡ trá»‹ inputRound
Â  Â  if(selectedMode === 'round1') displayRound.innerText = 'Hiá»‡p ' + rnum;
Â  Â  else if(selectedMode === 'round2') displayRound.innerText = 'Hiá»‡p ' + (rnum>=2? rnum : 2);
Â  Â  else if(selectedMode === 'round3') displayRound.innerText = 'Hiá»‡p ' + (rnum>=3? rnum : 3);
Â  }
Â  displayClock.innerText = formatTime(state.restRunning ? state.restLeft : state.timeLeft);
Â  displayRedName.innerText = state.redName || redNameInput.value || 'VÄV Äá»';
Â  displayBlueName.innerText = state.blueName || blueNameInput.value || 'VÄV XANH';
Â  eventTitle.innerText = state.eventTitle || tournamentNameInput.value || 'GIáº¢I IPES Má» Rá»˜NG NÄ‚M 2025';
Â  eventSubDisplay.innerText = state.eventSub || eventSubInput.value || '';
Â  document.title = `${displayRedName.innerText} ${state.redScore}-${state.blueScore} ${displayBlueName.innerText}`;
}

/* judge lights creation */
function createJudgeLights(){
Â  const redLights = document.getElementById('displayRedLights');
Â  const blueLights = document.getElementById('displayBlueLights');
Â  redLights.innerHTML = ''; blueLights.innerHTML = '';
Â  for(let j=1;j<=3;j++){
Â  Â  const d1 = document.createElement('div'); d1.className='judge-light'; d1.id=`light-red-${j}`;
Â  Â  d1.innerHTML = `<div class="badge">GÄ${j}</div><div class="sub">+?</div><div class="overlay"></div>`;
Â  Â  redLights.appendChild(d1);
Â  Â  const d2 = document.createElement('div'); d2.className='judge-light'; d2.id=`light-blue-${j}`;
Â  Â  d2.innerHTML = `<div class="badge">GÄ${j}</div><div class="sub">+?</div><div class="overlay"></div>`;
Â  Â  blueLights.appendChild(d2);
Â  }
}

/* overlay show points for judge light: hide badge/sub and show +X big */
function showJudgeOverlay(judge, side, points, dur=1500){
Â  const el = document.getElementById(`light-${side}-${judge}`);
Â  if(!el) return;
Â  const overlay = el.querySelector('.overlay');
Â  overlay.innerText = '+' + points;
Â  el.classList.add('on','showPoints');
Â  const badge = el.querySelector('.badge');
Â  const sub = el.querySelector('.sub');
Â  badge.style.visibility='hidden'; sub.style.visibility='hidden';
Â  if(state.judgeLightTimeouts[`${judge}-${side}`]) clearTimeout(state.judgeLightTimeouts[`${judge}-${side}`]);
Â  state.judgeLightTimeouts[`${judge}-${side}`] = setTimeout(()=>{ if(el){ el.classList.remove('showPoints'); overlay.innerText=''; badge.style.visibility='visible'; sub.style.visibility='visible'; el.classList.remove('on'); } delete state.judgeLightTimeouts[`${judge}-${side}`]; }, dur);
}

/* quick flash for +point (short) */
function quickPointFlash(side){
Â  const flash = side==='red' ? document.getElementById('leftFlash') : document.getElementById('rightFlash');
Â  if(!flash) return;
Â  flash.style.opacity = '0.9';
Â  setTimeout(()=>{ flash.style.opacity = '0'; }, 900); // ~1s flash
}

/* flash message */
function flashMessage(txt){
Â  const el = document.createElement('div'); el.style.position='fixed'; el.style.left='50%'; el.style.top='18px'; el.style.transform='translateX(-50%)'; el.style.background='linear-gradient(90deg,#121216,#0b0b0b)'; el.style.padding='10px 14px'; el.style.borderRadius='10px'; el.style.boxShadow='0 12px 40px rgba(0,0,0,0.6)'; el.style.zIndex=9999; el.style.color='#fff'; el.style.opacity='0'; el.style.transition='opacity .16s ease'; el.innerText = txt; document.body.appendChild(el); requestAnimationFrame(()=>el.style.opacity=1); setTimeout(()=>{ el.style.opacity=0; setTimeout(()=>el.remove(),300); },1600);
}

/* BEEP SOUNDS via WebAudio (no external files) */
function playTone(freq, duration=0.14, when=0, ctx=null){
Â  if(!soundToggle.checked) return;
Â  try{
Â  Â  const C = ctx || new (window.AudioContext || window.webkitAudioContext)();
Â  Â  const o = C.createOscillator();
Â  Â  const g = C.createGain();
Â  Â  o.type = 'sine';
Â  Â  o.frequency.value = freq;
Â  Â  g.gain.value = 0.0001;
Â  Â  o.connect(g); g.connect(C.destination);
Â  Â  const t = C.currentTime + when;
Â  Â  g.gain.setValueAtTime(0.0001, t);
Â  Â  g.gain.linearRampToValueAtTime(0.18, t+0.02);
Â  Â  g.gain.linearRampToValueAtTime(0.0001, t+duration);
Â  Â  o.start(t);
Â  Â  o.stop(t+duration+0.02);
Â  }catch(e){ console.warn('tone err', e); }
}
function playStartBeep(){ playTone(880, 0.12); } // single short
function playEnd3Beeps(){
Â  // three beeps: 0ms, +180ms, +360ms (sá»­ dá»¥ng khi háº¿t hiá»‡p)
Â  playTone(660, 0.12, 0);
Â  setTimeout(()=>playTone(660,0.12,0),180);
Â  setTimeout(()=>playTone(660,0.12,0),360);
}
// Ã‚m thanh "keng keng" khi háº¿t giá»/tráº­n/giáº£i lao (yÃªu cáº§u cá»§a báº¡n)
function playEndGameBeep(){
Â  playTone(980, 0.2, 0);
Â  setTimeout(()=>playTone(980,0.2,0), 300);
}
function playWinBeep(){ playTone(1200,0.12); } // optional single flourish for winner

/* WIN flash: blink whole card for 5s (0.5s on/off) + sound */
function winnerFlash(side){
Â  const isRed = (side==='red');
Â  const flash = isRed ? document.getElementById('leftFlash') : document.getElementById('rightFlash');
Â  const card = isRed ? document.getElementById('leftCard') : document.getElementById('rightCard');
Â  if(!flash || !card) return;
Â  card.style.position = card.style.position || 'relative';
Â  let visible = false;
Â  // play small win beep once at start
Â  playWinBeep();
Â  const interval = setInterval(()=> {
Â  Â  visible = !visible;
Â  Â  flash.style.opacity = visible ? '0.98' : '0'; // Nháº¥p nhÃ¡y tráº¯ng
Â  }, 500); // 0.5s toggle
Â  // stop after 5 seconds
Â  setTimeout(()=>{
Â  Â  clearInterval(interval);
Â  Â  flash.style.opacity = '0';
Â  }, 5000);
}

/* ADMIN manual score */
function manualScore(side, delta){
Â  if(window._manualScore) return window._manualScore(side, delta);
Â  if(side==='red') state.redScore = Math.max(-999, state.redScore + delta);
Â  else state.blueScore = Math.max(-999, state.blueScore + delta);
Â  // write to DB if available (keeps in sync)
Â  if(window.setMatchKey) window.setMatchKey(side+'Score', side==='red' ? state.redScore : state.blueScore);
Â  updateDisplay();
Â  flashMessage((delta>0?'+':'')+delta+' '+(side==='red'?'Äá»':'XANH')+' (TT)');
}

// Thay tháº¿ hÃ m judgeVote cá»¥c bá»™, chá»‰ Ä‘áº©y vote lÃªn DB
function judgeVote(judge, side, points){
Â  if(window.pushVote){
Â  Â  // Gá»­i vote lÃªn Firebase
Â  Â  window.pushVote({
Â  Â  Â  judge: judge,
Â  Â  Â  side: side,
Â  Â  Â  points: points,
Â  Â  Â  timestamp: Date.now()
Â  Â  });
Â  } else {
Â  Â  flashMessage("Lá»—i: KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c DB (Firebase)");
Â  }
}

/* full screen control button */
document.getElementById('btnFullscreenControl').addEventListener('click', ()=>{
Â  const el = document.getElementById('displaySection');
Â  if(!document.fullscreenElement) el.requestFullscreen && el.requestFullscreen();
Â  else document.exitFullscreen && document.exitFullscreen();
});

/* win buttons -> triggers winnerFlash and writes to DB if available */
document.getElementById('btnWinRed').addEventListener('click', async ()=>{
Â  winnerFlash('red');
Â  if(window.setMatchKey) await window.setMatchKey('lastWinner','red');
});
document.getElementById('btnWinBlue').addEventListener('click', async ()=>{
Â  winnerFlash('blue');
Â  if(window.setMatchKey) await window.setMatchKey('lastWinner','blue');
});

/* wire name inputs -> write to DB when changed (sync) */
redNameInput.addEventListener('input', ()=> {
Â  const v = redNameInput.value || '';
Â  if(window.setMatchKey) window.setMatchKey('redName', v);
Â  // update local state immediately for UX
Â  state.redName = v;
Â  updateDisplay();
});
blueNameInput.addEventListener('input', ()=> {
Â  const v = blueNameInput.value || '';
Â  if(window.setMatchKey) window.setMatchKey('blueName', v);
Â  state.blueName = v;
Â  updateDisplay();
});

/* event sub input -> write to DB when changed */
eventSubInput.addEventListener('input', ()=> {
Â  const v = eventSubInput.value || '';
Â  if(window.setMatchKey) window.setMatchKey('eventSub', v);
Â  state.eventSub = v;
Â  updateDisplay();
});

/* tournament name sync */
tournamentNameInput.addEventListener('input', ()=> {
Â  const v = tournamentNameInput.value || '';
Â  if(window.setMatchKey) window.setMatchKey('eventTitle', v);
Â  state.eventTitle = v;
Â  updateDisplay();
});

/* init */
createJudgeLights();
updateDisplay();

/* Round selection UI wiring (keeps display same layout). Set roundLabel in DB to sync to other devices */
function setSelectedModeLocal(mode){
Â  selectedMode = mode;
Â  document.querySelectorAll('.round-select-btn').forEach(b=>b.classList.remove('active'));
Â  if(mode === 'round1') document.getElementById('selRound1').classList.add('active');
Â  if(mode === 'round2') document.getElementById('selRound2').classList.add('active');
Â  if(mode === 'round3') document.getElementById('selRound3').classList.add('active');
Â  if(mode === 'rest') document.getElementById('selRest').classList.add('active');
Â  updateDisplay();
}
// On click: call setRound (which writes to DB) so other devices update
document.getElementById('selRound1').addEventListener('click', ()=> setRound('Hiá»‡p 1', 'round1', 1));
document.getElementById('selRound2').addEventListener('click', ()=> setRound('Hiá»‡p 2', 'round2', 2));
document.getElementById('selRound3').addEventListener('click', ()=> setRound('Hiá»‡p 3', 'round3', 3));
document.getElementById('selRest').addEventListener('click', ()=> setRound('Giáº£i lao', 'rest', parseInt(inputRound.value) || 1));

/* Bind admin control buttons - existing functions may be provided by Firebase module; we keep compatibility */
(function bindControlButtons(){
Â  const el = id => document.getElementById(id);
Â  if(el('btnStart')) el('btnStart').addEventListener('click', ()=> { if(window.startTimer) window.startTimer(); else { startTimerLocal(); } });
Â  if(el('btnPause')) el('btnPause').addEventListener('click', ()=> { if(window.pauseTimer) window.pauseTimer(); else { pauseTimerLocal(); } });
Â  if(el('btnResume')) el('btnResume').addEventListener('click', ()=> { if(window.resumeTimer) window.resumeTimer(); else { resumeTimerLocal(); } });
Â  // if(el('btnNextRound')) el('btnNextRound').addEventListener('click', ()=> { if(window.nextRound) window.nextRound(); else { nextRoundLocal(); } }); // REMOVED
Â  if(el('btnReset')) el('btnReset').addEventListener('click', ()=> {
Â  Â  if(!confirm('XÃ¡c nháº­n reset toÃ n bá»™ Ä‘iá»ƒm, hiá»‡p vÃ  xÃ³a lá»‹ch sá»­ cháº¥m Ä‘iá»ƒm?')) return;
Â  Â  if(window.resetAll) window.resetAll();
Â  Â  else { resetLocal(); }
Â  });
})();

/* -------------------- Local fallback timer logic -------------------- */
let _localTimerInterval = null;
function startTimerLocal(){
Â  // Sá»¬A: DÃ¹ng giÃ¡ trá»‹ cá»‘ Ä‘á»‹nh
Â  if(selectedMode === 'rest'){
Â  Â  state.restLeft = DEFAULT_REST_TIME;
Â  Â  state.restRunning = true;
Â  Â  state.timerRunning = false;
Â  Â  if(window.setMatchKey) window.setMatchKey('restLeft', state.restLeft);
Â  Â  if(window.setMatchKey) window.setMatchKey('restRunning', true);
Â  Â  if(window.setMatchKey) window.setMatchKey('roundLabel', 'rest');
Â  } else {
Â  Â  state.timePerRound = DEFAULT_ROUND_TIME; // Cá»‘ Ä‘á»‹nh 90s
Â  Â  state.timeLeft = state.timePerRound;
Â  Â  state.timerRunning = true;
Â  Â  state.restRunning = false;
Â  Â  const r = Math.max(1, parseInt(inputRound.value) || 1);
Â  Â  state.round = r;
Â  Â  if(window.setMatchKey) window.setMatchKey('round', r);
Â  Â  if(window.setMatchKey) window.setMatchKey('timePerRound', state.timePerRound);
Â  Â  if(window.setMatchKey) window.setMatchKey('timeLeft', state.timeLeft);
Â  Â  if(window.setMatchKey) window.setMatchKey('timerRunning', true);
Â  Â  if(window.setMatchKey) window.setMatchKey('roundLabel', selectedMode || 'round1');
Â  }
Â  if(window.setMatchKey) window.setMatchKey('lastUpdate', Date.now());
Â  updateDisplay();
Â  playStartBeep();
Â  if(_localTimerInterval) clearInterval(_localTimerInterval);
Â  _localTimerInterval = setInterval(()=>{
Â  Â  if(state.timerRunning){
Â  Â  Â  state.timeLeft = Math.max(0, state.timeLeft - 1);
Â  Â  Â  if(window.setMatchKey) window.setMatchKey('timeLeft', state.timeLeft);
Â  Â  Â  if(state.timeLeft === 0){
Â  Â  Â  Â  playEndGameBeep(); // DÃ¹ng Ã¢m thanh keng keng
Â  Â  Â  Â  state.timerRunning = false;
Â  Â  Â  Â  if(window.setMatchKey) { window.setMatchKey('timerRunning', false); window.setMatchKey('timeLeft', 0); }
Â  Â  Â  } else if (state.timeLeft <= 3 && state.timeLeft > 0) {
Â  Â  Â  Â  playEnd3Beeps(); // DÃ¹ng 3 tiáº¿ng bÃ­p cho 3s cuá»‘i
Â  Â  Â  }
Â  Â  } else if(state.restRunning){
Â  Â  Â  state.restLeft = Math.max(0, state.restLeft - 1);
Â  Â  Â  if(window.setMatchKey) window.setMatchKey('restLeft', state.restLeft);
Â  Â  Â  if(state.restLeft === 0){
Â  Â  Â  Â  playEndGameBeep(); // DÃ¹ng Ã¢m thanh keng keng
Â  Â  Â  Â  state.restRunning = false;
Â  Â  Â  Â  if(window.setMatchKey) { window.setMatchKey('restRunning', false); window.setMatchKey('restLeft', 0); }
Â  Â  Â  } else if (state.restLeft <= 3 && state.restLeft > 0) {
Â  Â  Â  Â  playEnd3Beeps(); // DÃ¹ng 3 tiáº¿ng bÃ­p cho 3s cuá»‘i
Â  Â  Â  }
Â  Â  }
Â  Â  updateDisplay();
Â  }, 1000);
}

function pauseTimerLocal(){
Â  state.timerRunning = false;
Â  state.restRunning = false;
Â  if(window.setMatchKey){ window.setMatchKey('timerRunning', false); window.setMatchKey('restRunning', false); window.setMatchKey('lastUpdate', Date.now()); }
Â  updateDisplay();
}

function resumeTimerLocal(){
Â  if(state.timeLeft > 0 && !state.timerRunning && selectedMode !== 'rest'){
Â  Â  state.timerRunning = true;
Â  Â  if(window.setMatchKey) window.setMatchKey('timerRunning', true);
Â  } else if(state.restLeft > 0 && !state.restRunning && selectedMode === 'rest'){
Â  Â  state.restRunning = true;
Â  Â  if(window.setMatchKey) window.setMatchKey('restRunning', true);
Â  }
Â  if(window.setMatchKey) window.setMatchKey('lastUpdate', Date.now());
Â  updateDisplay();
}

function resetLocal(){
Â  state.redScore = 0; state.blueScore = 0; state.round = 1;
Â  state.timePerRound = DEFAULT_ROUND_TIME; state.timeLeft = DEFAULT_ROUND_TIME; state.timerRunning = false;
Â  state.restTime = DEFAULT_REST_TIME; state.restLeft = DEFAULT_REST_TIME; state.restRunning = false;
Â  state.votes = [];
Â  state.processedAwardKeys = new Set();
Â  inputRound.value = 1; // reset input
Â  selectedMode = 'round1';
Â  setSelectedModeLocal('round1');
Â  createJudgeLights();
Â  updateDisplay();
Â  if(_localTimerInterval) clearInterval(_localTimerInterval);
Â  flashMessage("ÄÃ£ reset cá»¥c bá»™ vá» 0-0.");
}

/* -------------------- End local timer fallback -------------------- */
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getDatabase, ref, push, set, onChildAdded, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

/* CÃC GIÃ TRá»Š THá»œI GIAN Cá» Äá»ŠNH */
const DEFAULT_ROUND_TIME = 90; 
const DEFAULT_REST_TIME = 45; 

/* ---------- Firebase config (Sáº¿p Ä‘Ã£ cung cáº¥p) ---------- */
const firebaseConfig = {
Â  apiKey: "AIzaSyArFyjGuW7fBuRYu8jOGw_03OQQXtQjcj8",
Â  authDomain: "ipes-2b9db.firebaseapp.com",
Â  databaseURL: "https://ipes-2b9db-default-rtdb.asia-southeast1.firebasedatabase.app",
Â  projectId: "ipes-2b9db",
Â  storageBucket: "ipes-2b9db.firebasestorage.app",
Â  messagingSenderId: "410102574315",
Â  appId: "1:410102574315:web:191862efacd5e14a62e2ae",
Â  measurementId: "G-SCKTXEWZ6E"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const matchRef = ref(db, 'match');
const votesRef = ref(db, 'votes');
const awardsRef = ref(db, 'awards');

/* helper to update match keys */
window.setMatchKey = async function(key, val){
Â  await set(ref(db, `match/${key}`), val);
}

/* New helper: setRound(label, modeKey, roundNumber) -> writes both display label and mode key */
window.setRound = async function(displayLabel, modeKey, roundNumber){
Â  await set(ref(db, 'match/roundLabel'), modeKey);
Â  await set(ref(db, 'match/roundLabelText'), displayLabel);
Â  if(modeKey !== 'rest') {
Â  Â  await set(ref(db, 'match/round'), roundNumber);
Â  Â  // Cáº­p nháº­t input round cho tiá»‡n theo dÃµi
Â  Â  document.getElementById('inputRound').value = roundNumber;
Â  }
Â  // for local immediate feedback
Â  selectedMode = modeKey;
Â  setSelectedModeLocal(modeKey);
};

/* Bá»” SUNG: HÃ m Ä‘áº©y phiáº¿u báº§u lÃªn DB */
window.pushVote = async function(voteData){
Â  await push(votesRef, voteData);
}

/* ğŸ’¡ LOGIC CHÃNH: Xá»­ lÃ½ vÃ  tÃ­nh Ä‘iá»ƒm tá»« cÃ¡c phiáº¿u báº§u theo quy táº¯c 2s (ÄÃƒ Sá»¬A Lá»–I V4.2) */
function processVotes(votes){
Â  // Náº¿u má»™t pha ghi Ä‘iá»ƒm Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½ thÃ nh cÃ´ng, NGÄ‚N CHáº¶N viá»‡c xá»­ lÃ½ vote má»›i ngay láº­p tá»©c
Â  if (window.processingAward) {
Â  Â  console.log("Processing in progress, skipping vote processing.");
Â  Â  return;
Â  }
Â  
Â  const now = Date.now();
Â  const timeWindow = 2000; // 2 giÃ¢y
Â  // Táº¡o ID key Ä‘áº¡i diá»‡n cho cá»­a sá»• thá»i gian 2s nÃ y (chia háº¿t cho 2000)
Â  const timeBlockKey = Math.floor(now / timeWindow) * timeWindow; 
Â  
Â  // 1. Lá»c vÃ  láº¥y phiáº¿u báº§u Æ¯U TIÃŠN (chá»‰ láº¥y phiáº¿u má»›i nháº¥t cá»§a má»—i giÃ¡m Ä‘á»‹nh trong cá»­a sá»• 2s)
Â  const recentVotes = votes.filter(v => now - v.timestamp <= timeWindow);
Â  const prioritizedVotes = {}; 
Â  recentVotes.slice().reverse().forEach(v => {
Â  Â  if (!prioritizedVotes[v.judge]) {
Â  Â  Â  prioritizedVotes[v.judge] = v;
Â  Â  }
Â  });
Â  const finalVotes = Object.values(prioritizedVotes); 
Â  
Â  // 2. XÃ¡c Ä‘á»‹nh Side tháº¯ng (Quy táº¯c 1 & 6)
Â  const redVotesCount = finalVotes.filter(v => v.side === 'red').length;
Â  const blueVotesCount = finalVotes.filter(v => v.side === 'blue').length;
Â  
Â  let winningSide = null;
Â  if (redVotesCount >= 2 && redVotesCount > blueVotesCount) {
Â  Â  winningSide = 'red';
Â  } else if (blueVotesCount >= 2 && blueVotesCount > redVotesCount) {
Â  Â  winningSide = 'blue';
Â  }
Â  
Â  // 3. Náº¿u cÃ³ side tháº¯ng (>= 2 votes, Ã¡p Ä‘áº£o)
Â  if (winningSide) {
Â  Â  
Â  Â  // 4. XÃ¡c Ä‘á»‹nh loáº¡i Ä‘iá»ƒm Ä‘Æ°á»£c báº¥m nhiá»u nháº¥t (Quy táº¯c 7: PHáº¢I CÃ“ Äá»’NG THUáº¬N ÄIá»‚M Sá»)
Â  Â  const votesForWinningSide = finalVotes.filter(v => v.side === winningSide);
Â  Â  const point1Count = votesForWinningSide.filter(v => v.points === 1).length;
Â  Â  const point2Count = votesForWinningSide.filter(v => v.points === 2).length;
Â  Â  
Â  Â  let awardedPoints = 0;
Â  Â  
Â  Â  // Quy táº¯c 7.1: Äá»“ng thuáº­n +2
Â  Â  if (point2Count >= 2 && point2Count > point1Count) {
Â  Â  Â  awardedPoints = 2; // VÃ­ dá»¥: 2x(+2) vs 1x(+1) -> +2 Ä‘iá»ƒm
Â  Â  } 
Â  Â  // Quy táº¯c 7.2: Äá»“ng thuáº­n +1
Â  Â  else if (point1Count >= 2 && point1Count >= point2Count) {
Â  Â  Â  awardedPoints = 1; // VÃ­ dá»¥: 2x(+1) vs 1x(+2) -> +1 Ä‘iá»ƒm HOáº¶C 3x(+1) vs 0x(+2) -> +1 Ä‘iá»ƒm
Â  Â  }
Â  Â  // TrÆ°á»ng há»£p 1x(+1) vÃ  1x(+2) (Tá»•ng 2 phiáº¿u, khÃ´ng Ä‘á»“ng thuáº­n Ä‘iá»ƒm) => awardedPoints = 0
Â  Â  
Â  Â  if (awardedPoints > 0) {
Â  Â  Â  
Â  Â  Â  const uniqueAwardKey = `${winningSide}-${timeBlockKey}`;
Â  Â  Â  
Â  Â  Â  // Quy táº¯c 3: Kiá»ƒm tra key chá»‘ng trÃ¹ng láº·p.
Â  Â  Â  if(!state.processedAwardKeys.has(uniqueAwardKey)){
Â  Â  Â  Â  
Â  Â  Â  Â  // Báº­t cá» Ä‘á»ƒ cháº·n cÃ¡c láº§n cháº¡y processVotes tiáº¿p theo trong vÃ i giÃ¢y
Â  Â  Â  Â  window.processingAward = true;
Â  Â  Â  Â  
Â  Â  Â  Â  // ThÃªm key vÃ o set cá»¥c bá»™ ngay láº­p tá»©c Ä‘á»ƒ cháº·n cÃ¡c vote khÃ¡c trong cÃ¹ng 1 client
Â  Â  Â  Â  state.processedAwardKeys.add(uniqueAwardKey);
Â  Â  Â  Â  
Â  Â  Â  Â  // 5. Cá»™ng Ä‘iá»ƒm vÃ o DB báº±ng Transaction
Â  Â  Â  Â  runTransaction(ref(db, `match/${winningSide}Score`), (currentScore) => {
Â  Â  Â  Â  Â  return (currentScore || 0) + awardedPoints; 
Â  Â  Â  Â  }).then(()=>{
Â  Â  Â  Â  Â  // 6. Sau khi Transaction thÃ nh cÃ´ng, Ghi nháº­n Award
Â  Â  Â  Â  Â  const newAwardData = {
Â  Â  Â  Â  Â  Â  side: winningSide,
Â  Â  Â  Â  Â  Â  points: awardedPoints,
Â  Â  Â  Â  Â  Â  timestamp: Date.now(),
Â  Â  Â  Â  Â  Â  judges: votesForWinningSide.map(v => v.judge), // Váº«n lÆ°u cÃ¡c giÃ¡m Ä‘á»‹nh Ä‘Ã£ báº¥m
Â  Â  Â  Â  Â  Â  key: uniqueAwardKey 
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  push(awardsRef, newAwardData);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Táº¯t cá» sau 2s Ä‘á»ƒ cho phÃ©p xá»­ lÃ½ votes tiáº¿p theo
Â  Â  Â  Â  Â  setTimeout(()=>{
Â  Â  Â  Â  Â  Â  window.processingAward = false;
Â  Â  Â  Â  Â  }, timeWindow); 
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  }
Â  // XÃ³a cÃ¡c phiáº¿u báº§u cÅ© hÆ¡n 2 giÃ¢y khá»i máº£ng cá»¥c bá»™
Â  state.votes = recentVotes;
}

/* ğŸ’¡ HÃ m xÃ³a toÃ n bá»™ dá»¯ liá»‡u tráº­n Ä‘áº¥u (Reset) */
window.resetAll = async function(){
Â  // 1. XÃ³a toÃ n bá»™ phiáº¿u báº§u vÃ  sá»± kiá»‡n cá»™ng Ä‘iá»ƒm
Â  await set(votesRef, null); // XÃ³a node /votes
Â  await set(awardsRef, null); // XÃ³a node /awards
Â  
Â  // 2. Reset cÃ¡c tráº¡ng thÃ¡i trong node /match
Â  const redName = document.getElementById('redName').value;
Â  const blueName = document.getElementById('blueName').value;
Â  const eventTitle = document.getElementById('tournamentName').value;
Â  const eventSub = document.getElementById('eventSubInput').value;

Â  await set(matchRef, {
Â  Â  redScore: 0,
Â  Â  blueScore: 0,
Â  Â  round: 1,
Â  Â  timerRunning: false,
Â  Â  restRunning: false,
Â  Â  timeLeft: DEFAULT_ROUND_TIME,
Â  Â  restLeft: DEFAULT_REST_TIME,
Â  Â  roundLabel: 'round1',
Â  Â  roundLabelText: 'Hiá»‡p 1',
Â  Â  lastUpdate: Date.now(),
Â  Â  redName: redName,
Â  Â  blueName: blueName,
Â  Â  eventTitle: eventTitle,
Â  Â  eventSub: eventSub
Â  });

Â  // 3. Reset tráº¡ng thÃ¡i cá»¥c bá»™ cá»§a á»©ng dá»¥ng
Â  state.votes = [];
Â  state.processedAwardKeys = new Set();
Â  window.processingAward = false; // Reset cá» xá»­ lÃ½
Â  document.getElementById('inputRound').value = 1;
Â  selectedMode = 'round1';
Â  setSelectedModeLocal('round1');
Â  
Â  flashMessage("ÄÃ£ reset toÃ n bá»™ tráº­n Ä‘áº¥u vÃ  Ä‘iá»ƒm sá»‘ vá» 0-0.");
};


/* ğŸ’¡ Listener cho Votes (Realtime): Báº¯t cÃ¡c phiáº¿u báº§u má»›i */
onChildAdded(votesRef, (snapshot) => {
Â  
Â  const newVote = snapshot.val();
Â  
Â  // ******************************************************
Â  // Sá»¬A V4.2: Báº­t Ä‘Ã¨n bÃ¡o hiá»‡u Ä‘Ã£ báº¥m ngay láº­p tá»©c (TÃ­n hiá»‡u)
Â  // ******************************************************
Â  const el = document.getElementById(`light-${newVote.side}-${newVote.judge}`);
Â  if(el){ 
Â  Â  // 1. Táº¯t timeout cÅ© náº¿u cÃ³
Â  Â  if(state.judgeLightTimeouts[`${newVote.judge}-${newVote.side}-signal`]) clearTimeout(state.judgeLightTimeouts[`${newVote.judge}-${newVote.side}-signal`]);

Â  Â  // 2. Báº­t Ä‘Ã¨n & cáº­p nháº­t Ä‘iá»ƒm hiá»ƒn thá»‹
Â  Â  el.classList.add('on'); 
Â  Â  el.querySelector('.sub').innerText = `+${newVote.points}`;
Â  Â  el.querySelector('.overlay').innerText = `+${newVote.points}`; // Cáº­p nháº­t overlay cho cháº¯c
Â  Â  
Â  Â  // 3. Set timeout Ä‘á»ƒ táº¯t Ä‘Ã¨n sau 1s (chá»‰ lÃ  tÃ­n hiá»‡u báº¥m)
Â  Â  state.judgeLightTimeouts[`${newVote.judge}-${newVote.side}-signal`] = setTimeout(()=>{ 
Â  Â  Â  if(el && !el.classList.contains('showPoints')){ 
Â  Â  Â  Â  el.classList.remove('on'); 
Â  Â  Â  } 
Â  Â  Â  delete state.judgeLightTimeouts[`${newVote.judge}-${newVote.side}-signal`];
Â  Â  }, 1000); 
Â  }
Â  
Â  // Náº¿u Ä‘ang xá»­ lÃ½ award, khÃ´ng tiáº¿n hÃ nh processVotes
Â  if (window.processingAward) {
Â  Â  console.log("Processing award. New vote received but skipped processing to prevent double score.");
Â  Â  return;
Â  }
Â  
Â  // LÆ°u vote má»›i
Â  state.votes.push(newVote);
Â  // Chá»‰ giá»¯ cÃ¡c vote trong 2s gáº§n nháº¥t
Â  const now = Date.now();
Â  state.votes = state.votes.filter(v => now - v.timestamp <= 2000);
Â  
Â  // Sau má»—i phiáº¿u báº§u, kiá»ƒm tra Ä‘iá»u kiá»‡n cháº¥m Ä‘iá»ƒm
Â  processVotes(state.votes);
});


/* ğŸ’¡ Listener cho Awards (Äá»“ng bá»™ hiá»‡u á»©ng): Khi Ä‘iá»ƒm Ä‘Æ°á»£c cá»™ng thÃ nh cÃ´ng */
onChildAdded(awardsRef, (snapshot) => {
Â  const award = snapshot.val();
Â  
Â  // ******************************************************
Â  // Sá»¬A V4.2: Chá»‰ dÃ¹ng Award Ä‘á»ƒ flash/sound/update_score/chá»‘ng_trÃ¹ng_láº·p
Â  // ÄÃ¨n giÃ¡m Ä‘á»‹nh Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½ á»Ÿ onChildAdded(votesRef)
Â  // ******************************************************
Â  
Â  if(state.processedAwardKeys.has(award.key)) return; // TrÃ¡nh xá»­ lÃ½ trÃ¹ng
Â  
Â  // Cá»™ng Ä‘iá»ƒm cá»¥c bá»™ (Chá»‰ dÃ¹ng cho view)
Â  if(award.side === 'red') state.redScore = Math.max(-999, state.redScore + award.points);
Â  else state.blueScore = Math.max(-999, state.blueScore + award.points);
Â  
Â  quickPointFlash(award.side);
Â  flashMessage(`+${award.points} ${award.side === 'red' ? 'Äá»' : 'XANH'} (Äá»“ng thuáº­n)`);
Â  
Â  // Hiá»ƒn thá»‹ Ä‘Ã¨n giÃ¡m Ä‘á»‹nh Ä‘Ã£ cháº¥m thÃ nh cÃ´ng VÃ€ GIá»® SÃNG LÃ‚U HÆ N (dÃ¹ng showJudgeOverlay)
Â  award.judges.forEach(judge => {
Â  Â  showJudgeOverlay(judge, award.side, award.points);
Â  });

Â  // ÄÃ¡nh dáº¥u Ä‘Ã£ xá»­ lÃ½ Ä‘á»ƒ Ä‘á»“ng bá»™ vá»›i cÃ¡c client khÃ¡c
Â  state.processedAwardKeys.add(award.key);
Â  
Â  // Báº­t cá» xá»­ lÃ½ cho cÃ¡c client khÃ¡c vá»«a nháº­n Ä‘Æ°á»£c Award
Â  window.processingAward = true;
Â  setTimeout(()=>{
Â  Â  window.processingAward = false;
Â  }, 2000); // 2s cá»
Â  
Â  updateDisplay();
});


/* initialize match default if not present (safe) */
onValue(matchRef, (snap)=>{
Â  const m = snap.val() || {};
Â  
Â  // Logic cáº­p nháº­t tráº¡ng thÃ¡i
Â  const newRedScore = m.redScore || 0;
Â  const newBlueScore = m.blueScore || 0;

Â  // Kiá»ƒm tra náº¿u Ä‘iá»ƒm thay Ä‘á»•i, update local
Â  if(newRedScore !== state.redScore || newBlueScore !== state.blueScore){
Â  Â  state.redScore = newRedScore;
Â  Â  state.blueScore = newBlueScore;
Â  }

Â  // Timer logic 
Â  const wasRunning = state.timerRunning || state.restRunning;
Â  const now = Date.now();
Â  const timeSinceLastUpdate = (now - (m.lastUpdate || now)) / 1000;

Â  state.round = m.round || 1;
Â  state.timePerRound = DEFAULT_ROUND_TIME; // Sá»¬A: DÃ¹ng giÃ¡ trá»‹ cá»‘ Ä‘á»‹nh
Â  state.restTime = DEFAULT_REST_TIME; // Sá»¬A: DÃ¹ng giÃ¡ trá»‹ cá»‘ Ä‘á»‹nh
Â  
Â  // Cáº­p nháº­t tráº¡ng thÃ¡i vÃ  thá»i gian cÃ²n láº¡i
Â  state.timerRunning = !!m.timerRunning;
Â  state.restRunning = !!m.restRunning;
Â  selectedMode = m.roundLabel || 'round1';
Â  setSelectedModeLocal(selectedMode);

Â  if(state.timerRunning){
Â  Â  state.timeLeft = m.timeLeft != null ? m.timeLeft : state.timePerRound;
Â  Â  if(wasRunning) state.timeLeft = Math.max(0, state.timeLeft - Math.round(timeSinceLastUpdate));
Â  Â  if(state.timeLeft === 0) {
Â  Â  Â  // Háº¿t giá»: Táº¯t timer vÃ  phÃ¡t Ã¢m thanh
Â  Â  Â  state.timerRunning = false;
Â  Â  Â  if(m.timerRunning) playEndGameBeep();
Â  Â  }
Â  } else if(state.restRunning){
Â  Â  state.restLeft = m.restLeft != null ? m.restLeft : state.restTime;
Â  Â  if(wasRunning) state.restLeft = Math.max(0, state.restLeft - Math.round(timeSinceLastUpdate));
Â  Â  if(state.restLeft === 0) {
Â  Â  Â  // Háº¿t giá» giáº£i lao: Táº¯t timer vÃ  phÃ¡t Ã¢m thanh
Â  Â  Â  state.restRunning = false;
Â  Â  Â  if(m.restRunning) playEndGameBeep();
Â  Â  }
Â  } else {
Â  Â  // Timer dá»«ng: giá»¯ nguyÃªn giÃ¡ trá»‹
Â  Â  state.timeLeft = m.timeLeft != null ? m.timeLeft : state.timePerRound;
Â  Â  state.restLeft = m.restLeft != null ? m.restLeft : state.restTime;
Â  }

Â  // Cáº­p nháº­t tÃªn vÃ  tiÃªu Ä‘á»
Â  state.redName = m.redName || redNameInput.value;
Â  state.blueName = m.blueName || blueNameInput.value;
Â  state.eventTitle = m.eventTitle || tournamentNameInput.value;
Â  state.eventSub = m.eventSub || eventSubInput.value;

Â  // Äá»“ng bá»™ giÃ¡ trá»‹ input náº¿u lÃ  mÃ¡y chá»§ Ä‘iá»u khiá»ƒn
Â  if(m.round) inputRound.value = m.round;
Â  
Â  updateDisplay();
Â  state.lastUpdate = now;
});

/* Helper functions for timer control (using DB setMatchKey to sync state) */
window.startTimer = async function(){
Â  const isRest = selectedMode === 'rest';
Â  const timeLeft = isRest ? DEFAULT_REST_TIME : DEFAULT_ROUND_TIME;
Â  await setMatchKey('timerRunning', !isRest);
Â  await setMatchKey('restRunning', isRest);
Â  await setMatchKey(isRest ? 'restLeft' : 'timeLeft', timeLeft);
Â  await setMatchKey('lastUpdate', Date.now());
Â  if(!isRest) await setMatchKey('round', parseInt(inputRound.value) || 1);
Â  playStartBeep();
};

window.pauseTimer = async function(){
Â  await setMatchKey('timerRunning', false);
Â  await setMatchKey('restRunning', false);
Â  await setMatchKey('lastUpdate', Date.now());
};

window.resumeTimer = async function(){
Â  const isRest = selectedMode === 'rest';
Â  if(isRest){
Â  Â  if(state.restLeft > 0) await setMatchKey('restRunning', true);
Â  } else {
Â  Â  if(state.timeLeft > 0) await setMatchKey('timerRunning', true);
Â  }
Â  await setMatchKey('lastUpdate', Date.now());
};
</script>